<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>United States Metropolitan Areas</title>
        <style type="text/css">

            div.center {
                display: block;
                margin-left: auto;
                margin-right: auto;
                width: 960px;
            }

            #valueselect {
                margin-left: auto;
                margin-right: auto;
            }

            h1, p {
                text-align:left;
                line-height:100%;
                font-family:"Helvetica Neue", Helvetica, sans-serif;
                font-weight: 300;
            }

            h1 {
                line-height:40%;
            }

        	.counties {
                fill: none;
            }

            .states {
                fill: none;
                stroke-linejoin: round;
            }

        </style>

        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="http://d3js.org/queue.v1.min.js"></script>
        <script src="http://d3js.org/topojson.v1.min.js"></script>
        <script src="http://d3js.org/colorbrewer.v1.min.js"></script>

    </head>
    <body>
    <div id = "map" class ="center">
        <h1>Metropolitan local governments</h1>
        <p>Explore America's local governments in their metropolitan environment</p>
        
        <select id = "dateselect">
        	<option value="1950">1950</option>
        	<option value="1980">1980</option>
        	<option value="2010" selected="selected">2010</option>
        </select>

        <select id = "valueselect">
        	<option value="CBSAhhi"		  >H Index (Dilution of power): Counties and Municipalities</option>
        </select>

        <select id = "scaletype">
            <option value="quantile"      >Quantile scale (equal number of cases)</option>
            <option value="quantize"      >Quantize scale (even divison of scale domain)</option>
        </select>

        <select id = "showstates">
            <option value="yes"                    >Show states</option>
            <option value="no" selected="selected" >Don't show states</option>
        </select>


        </br>
    </div>
        <script type="text/javascript">
            
        var width = 960,
            height = 600;

        // Size of the legend squares
        var lsize = 20;
        var lpush = 530;

        var value = "CBSAhhi";
        var date = "2010";

        // Scale

        var rangeColors = colorbrewer.Blues[9];

        var noDataColor = "WhiteSmoke";

        var showstates = "no";

        // Scale
        var scaletype = "quantile";
        var scale;

        var updateScale= function() {
            if(scaletype == "quantile") {
                scale = d3.scale.quantile()
                        .range(rangeColors)
                        .domain(values[value + '_' + date].values());
            } else if(scaletype == "quantize") {
                scale = d3.scale.quantize()
                        .range(rangeColors)
                        .domain([
                            d3.min(d3.values(values[value + '_' + date])),
                            d3.max(d3.values(values[value + '_' + date]))
                        ]);
            }
        }

        var projection = d3.geo.albersUsa()
            .scale(1280)
            .translate([width / 2, height / 2])

        var path = d3.geo.path()
            .projection(projection);

        var svg = d3.select("#map").append("svg")
            .attr("width", width)
            .attr("height", height);

        var updateCounties;
        var updateStates;
        

        var legend;
        var leglabels;
        var makeLegend = function() {
            
        	// Get the range (colors)
            var r = scale.range();
                        
            // Get the domain (boundaries)
            var v = [];
            if(scaletype == "quantile"){
            	v.push(parseFloat(d3.min(scale.domain())));
            	v = v.concat(scale.quantiles());
            	v.push(parseFloat(d3.max(scale.domain())));
            } else {
            	v.push(parseFloat(scale.domain()[0]));
            	for(var i = 0; i < r.length; i++) {
            		var k = (scale.domain()[1] - scale.domain()[0]) * (i+1) + scale.domain()[0];
            		v.push(k);
            	}
            	
            };
            
            
            // Draw the range (color blocks)
            var legend = svg.append("g")
            	.attr("id", "legend")
            	.selectAll(".legend")
                .data(r)
                .enter().append("rect")
                .attr("x", width - lsize - 50)
                .attr("y", function(d,i){
                    return height - 100 - i * (lsize + 1);
                })
                .attr("width",lsize / 2)
                .attr("height",lsize)
                .attr("fill", function(d){
                    return d;
                });

            // Draw the domain text (boundaries)
            leglabels = svg.select("#legend")
            				.selectAll(".leglabel")
            				.data(v)
            				.enter().append("text")
                			.attr("x", width - lsize - 30)
                			.attr("y", function(d,i){
                    			return height - 77 - i * (lsize + 1);
                			})
                			.text(function(d){return d.toFixed(2);})
                			.attr("font-family", "sans-serif")
                			.attr("font-size", "10px");
        }

        var updateLegend = function() {
            var r = scale.range();
            var v = [];
            if(scaletype == "quantile"){
            	v.push(parseFloat(d3.min(scale.domain())));
            	v = v.concat(scale.quantiles());
            	v.push(parseFloat(d3.max(scale.domain())));
            } else {
            	v.push(parseFloat(scale.domain()[0]));
            	for(var i = 0; i < r.length; i++) {
            		var k = ((scale.domain()[1] - scale.domain()[0]) / r.length) * (i+1) + scale.domain()[0];
            		v.push(k);
            	}
            	
            };

            //Update data: find a d3esque way of doing it
            for(var i = 0; i < leglabels[0].length; i++){
            	leglabels[0][i]["__data__"] = v[i];
            }

            leglabels.transition()
            		.duration(500)
            		.text(function(d){return d.toFixed(2);});
        };


        // Map the csv with county ids
        var values = {};
        var mapData = function(data) {
        	var keys = Object.keys(data[0]);

        	// Initialize maps
        	for (var i = 0; i < keys.length; i ++) {
        		values[keys[i]] = d3.map();
        	}

            // Get the keys to convert to float
            // Keys listed in the selector
            var x = document.getElementById("valueselect");
            var ktf = [];
            for (var i = 0; i < x.length; i++) {
                ktf.push(x.options[i].value);
            };

        	// Map for each county
        	for (var i = 0; i < data.length; i ++) {
        		var d = data[i];
        		for (var j = 0; j < keys.length; j ++) {
        			var v = d[keys[j]];
                    // Transform NA strings into null values
                    if(v == "NA") {
                        v = null;
                    }
                    if(ktf.indexOf(keys[j]) >= 0) {
                        values[keys[j]].set(d.id, parseFloat(v));
                    } else {
                        values[keys[j]].set(d.id, v);
                    }
        		}
        	}
        	console.log("Data mapped")
        }

        queue()
            .defer(d3.json, "topo/us-euclidean.json")
            .defer(d3.csv, "data/A_MetroByCounty.csv")
            .await(ready);

        function ready(error, us, data) {

            //console.log(data);

            // Map the data with json elements
        	mapData(data);
            updateScale();
            makeLegend();

            var counties = svg.append("g")
                    .attr("class", "counties");

            counties.selectAll("path")
                .data(topojson.feature(us, us.objects.counties).features)
            .enter().append("path")
                .style("fill", function(d) {
                    var v = values[value + '_' + date].get(d.id);
                    if(!isNaN(v)) {return scale(v);}
                    else {return noDataColor;}                       
                })
                .attr("d", path)
                .append("title")
                .text(function(d){
                    var title = values["CBSAname_" + date].get(d.id);
                    var county = values["countyname"].get(d.id);
                    if(title != null) {
                    	return (county + ", " + title);
                    } else {
                    	return (county);
                    }
                })
                ;

            // Draw states borders
            var states = svg.append("path")
                            .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
                            .attr("class", "states")
                            .attr("id", "states")
                            .attr("d", path)
                            .style("stroke", "#fff")
                            .style("stroke-width", "0");

            

            ////////////////////
            // UPDATE METHODS //

            updateCounties = function() {
            updateScale();
            updateLegend();
            console.log("Redrawing counties")
            counties.selectAll("path")
                .data(topojson.feature(us, us.objects.counties).features)
                .transition()
                .duration(500)
                .style("fill", function(d) {
                    var v = values[value + '_' + date].get(d.id);
                    if(!isNaN(v)) {return scale(v);}
                    else {return noDataColor;}                 
                });
            }

            updateStates = function() {
                console.log("Update States")
                var w = 0;
                if(showstates == "yes") {w = 2;}
                svg.select("#states")
                    .transition()
                    .duration(500)
                    .style("stroke-width", w);
            }
            
        }

        d3.select("#valueselect")
            .on("change", function() {
                value = d3.select("#valueselect").node().value;
                updateCounties();
            })


        d3.select("#scaletype")
            .on("change", function() {
                scaletype = d3.select("#scaletype").node().value;
                updateCounties();
            })

        d3.select("#dateselect")
            .on("change", function() {
                date = d3.select("#dateselect").node().value;
                updateCounties();
            })

        d3.select("#showstates")
            .on("change", function() {
                showstates = d3.select("#showstates").node().value;
                updateStates();
            })



        d3.select(self.frameElement).style("height", height + "px");

        </script>

        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-51162032-1', 'metroatlas.github.io');
            ga('send', 'pageview');
        </script>

    </body>
</html>