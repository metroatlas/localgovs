<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>United States Metropolitan Areas</title>
        <style type="text/css">

            div.center {
                display: block;
                margin-left: auto;
                margin-right: auto;
                width: 960px;
            }

            #valueselect {
                margin-left: auto;
                margin-right: auto;
            }

            h1, p {
                text-align:left;
                line-height:100%;
                font-family:"Helvetica Neue", Helvetica, sans-serif;
                font-weight: 300;
            }

            h1 {
                line-height:40%;
            }

        	.counties {
                fill: none;
            }

            .states {
                fill: none;
                stroke-linejoin: round;
            }

        </style>

        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="http://d3js.org/queue.v1.min.js"></script>
        <script src="http://d3js.org/topojson.v1.min.js"></script>

    </head>
    <body>
    <div id = "map" class ="center">
        <h1>Metropolitan local governments</h1>
        <p>Explore America's local governments in their metropolitan environment</p>
        <select id = "valueselect">
        	<option value="CBSAhhi"		  >H Index (Dilution of power): Counties and Municipalities</option>
        	<option value="CBSAhhico"	  >H Index (Dilution of power): Counties only</option>
        	<option value="CBSAhhipl"	  >H Index (Dilution of power): Municipalities only</option>
            <option value="CBSAmdpi2007"  >Metropolitan Power Diffusion Index (2007)</option>
            <option value="CBSAzb"        >Ziegler-Brunn Index</option>
            <option value="CBSAplby10000" >Number of municipalities per 10'000 inhabitants</option>
            <option value="CBSApcprop"    >Proportion of population in principal cities</option>
        </select>

        <select id = "scaletype">
            <option value="quantile"      >Quantile scale (equal number of cases)</option>
            <option value="quantize"      >Quantize scale (even divison of scale domain)</option>
        </select>

        <select id = "showstates">
            <option value="yes"                    >Show states</option>
            <option value="no" selected="selected" >Don't show states</option>
        </select>


        </br>
    </div>
        <script type="text/javascript">
            
        var width = 960,
            height = 600;

        var value = "CBSAhhi";

        // Scale

        var rangeColors = [
        	"rgb(247,251,255)",
        	"rgb(222,235,247)",
        	"rgb(198,219,239)",
        	"rgb(158,202,225)",
        	"rgb(107,174,214)",
        	"rgb(66,146,198)",
        	"rgb(33,113,181)",
        	"rgb(8,81,156)",
        	"rgb(8,48,107)"
        	]

        var noDataColor = "WhiteSmoke";

        var showstates = "no";

        // Scale
        var scaletype = "quantile";
        var scale;

        var updateScale= function() {
            if(scaletype == "quantile") {
                scale = d3.scale.quantile()
                        .range(rangeColors)
                        .domain(values[value].values());
            } else if(scaletype == "quantize") {
                scale = d3.scale.quantize()
                        .range(rangeColors)
                        .domain([
                            d3.min(d3.values(values[value])),
                            d3.max(d3.values(values[value]))
                        ]);
            }
        }

        var projection = d3.geo.albersUsa()
            .scale(1280)
            .translate([width / 2, height / 2])

        var path = d3.geo.path()
            .projection(projection);

        var svg = d3.select("#map").append("svg")
            .attr("width", width)
            .attr("height", height);

        var updateCounties;
        var updateStates;

        // Map the csv with county ids
        var values = {};
        var mapData = function(data) {
        	var keys = Object.keys(data[0]);
        	//console.log(keys);
        	// Initialize maps
        	for (var i = 0; i < keys.length; i ++) {
        		values[keys[i]] = d3.map();
        	}

        	// Map for each county
        	for (var i = 0; i < data.length; i ++) {
        		var d = data[i];
        		for (var j = 0; j < keys.length; j ++) {
        			var v = d[keys[j]];
                    // Transform NA strings into null values
                    if(v == "NA") {
                        v = null;
                    }
                    values[keys[j]].set(d.id, v);
        		}
        	}
        	console.log("Data mapped")
        }

        queue()
            .defer(d3.json, "us.json")
            .defer(d3.csv, "A_CBSA_ByCounty_2010.csv")
            .await(ready);

        function ready(error, us, data) {

            //console.log(data);

            // Map the data with json elements
        	mapData(data);
            updateScale();

            var counties = svg.append("g")
                    .attr("class", "counties");

            counties.selectAll("path")
                .data(topojson.feature(us, us.objects.counties).features)
            .enter().append("path")
                .style("fill", function(d) {
                    var v = values[value].get(d.id);
                    if(v != null) {return scale(v);}
                    else {return noDataColor;}                       
                })
                .attr("d", path)
                .append("title")
                .text(function(d){
                    var title = values["CBSATitle"].get(d.id);
                    var county = values["CountyName"].get(d.id);
                    if(title != null) {
                    	return (county + " County, " + title);
                    } else {
                    	return (county + " County");
                    }
                })
                ;

            // Draw states borders
            var states = svg.append("path")
                            .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
                            .attr("class", "states")
                            .attr("id", "states")
                            .attr("d", path)
                            .style("stroke", "#fff")
                            .style("stroke-width", "0");


            updateCounties = function() {
            updateScale();
            console.log("Redrawing counties")
            counties.selectAll("path")
                .data(topojson.feature(us, us.objects.counties).features)
                .transition()
                .duration(500)
                .style("fill", function(d) {
                    var v = values[value].get(d.id);
                    if(v != null) {return scale(v);}
                    else {return noDataColor;}                 
                });
            }

            updateStates = function() {
                console.log("Update States")
                var w = 0;
                if(showstates == "yes") {w = 2;}
                console.log(w)
                svg.select("#states")
                    .transition()
                    .duration(500)
                    .style("stroke-width", w);
            }
        }

        d3.select("#valueselect")
            .on("change", function() {
                value = d3.select("#valueselect").node().value;
                updateCounties();
            })

        d3.select("#scaletype")
            .on("change", function() {
                scaletype = d3.select("#scaletype").node().value;
                updateCounties();
            })

        d3.select("#showstates")
            .on("change", function() {
                showstates = d3.select("#showstates").node().value;
                updateStates();
            })

        d3.select(self.frameElement).style("height", height + "px");

        </script>

        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-51162032-1', 'metroatlas.github.io');
            ga('send', 'pageview');
        </script>

    </body>
</html>