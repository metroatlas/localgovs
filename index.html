<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>United States Metropolitan Areas</title>
        <link rel="stylesheet" type="text/css" href="style.css">

        <!-- EXTERNAL JAVASCRIPT LIBRARIES -->

        <!-- MathJax to display latex math -->
        <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Numeral.js to format numbers nicely -->
        <script src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/1.4.5/numeral.min.js"></script>

        <!-- d3js for maps and data visualization -->
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="http://d3js.org/queue.v1.min.js"></script>
        <script src="http://d3js.org/topojson.v1.min.js"></script>

        <!-- ColorBrewer for nice color scales -->
        <script src="http://d3js.org/colorbrewer.v1.min.js"></script>

        <!-- JQuery to manipulate the DOM -->
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

        <!-- INTERNAL JAVASCRIPT LIBRARIES -->

        <!-- d3.atlas to serialize maps -->
        <script src="js/atlas.js"></script>

        <!-- d3.mapper to serialize maps of variables -->
        <script src="js/mapper.js"></script>

        <!-- d3.menu to display a menu with these variables -->
        <script src="js/menu.js"></script>

    </head>
    <body>

    <!--Basic structure of the page-->

    <div id = "menu" class ="center">
        <p><a href="../">&lt; Metropolitan Atlas</a></p>
        <h1>Metropolitan local governments</h1>
        <p>Explore America's local governments in their metropolitan environment</p>
        <span id = "menu"></span>
        <select id = "scaletype">
            <option value="quantile"      >Quantile scale (equal number of cases)</option>
            <option value="quantize"      >Quantize scale (even divison of scale domain)</option>
        </select>

        <select id = "showstates">
            <option value="yes"                    >Show states</option>
            <option value="no" selected="selected" >Don't show states</option>
        </select>


        </br>
    </div>
    <div id="map" class="center"></div>
    <div class="center">
        <div id="variablebox">
            <div id="plot"></div>
            <div id="variabletxt"></div>
        </div>
        <div id="infometro"></div>
    </div>

    <!--Scripts-->

        <script type="text/javascript">
        
        // THE MAP

        var mapCounties;

        var id;
        var width = 960,
            height = 600;

        // Size of the legend squares
        var lsize = 20;
        var lpush = 530;

        var value = "countypop";
        var date = "2010";

        // Page structure
        var divInfoMetro    = "#infometro",
            divVariableBox  = "#variablebox",
            divVariableTxt  = "#variabletxt",
            divPlot         = "#plot";

        // Colors

        var rangeColors = colorbrewer.Blues[9];

        var noDataColor = "WhiteSmoke";
        var selectColor = "Orange";

        var showstates = "no";

        // Scale
        var scaletype = "quantile";
        var scale;

        var topo;
        var thedata;

        var updateScale= function() {
            if(scaletype == "quantile") {
                scale = d3.scale.quantile()
                        .range(rangeColors)
                        .domain(mapper.get({'variable':value, 'date':date}).values());
            } else if(scaletype == "quantize") {
                scale = d3.scale.quantize()
                        .range(rangeColors)
                        .domain([
                            d3.min(d3.values(mapper.get({'variable':value, 'date':date}))),
                            d3.max(d3.values(mapper.get({'variable':value, 'date':date})))
                        ]);
            }
        }

        var projection = d3.geo.albersUsa()
            .scale(1280)
            .translate([width / 2, height / 2])

        var path = d3.geo.path()
            .projection(projection);

        // SVG map
        var svgMap = d3.select("#map").append("svg")
            .attr("width", width)
            .attr("height", height);

        // SVG plot
        var plotHeight = 500;
        var plotWidth = 470;

        var plotPadding = 30;

        var plotXScale = d3.scale.log()
        var plotYScale = d3.scale.linear()

        var plotXAxis = d3.svg.axis()
        var plotYAxis = d3.svg.axis()

        var plotSvg = d3.select("plot")
                    .append("svg")
                    .attr("width", plotWidth)
                    .attr("height", plotHeight);

        // Initialize update variables
        var updateCounties;
        var updateStates;
        

        var legend;
        var leglabels;
        var makeLegend = function() {
            
        	// Get the range (colors)
            var r = scale.range();
                        
            // Get the domain (boundaries)
            var v = [];
            if(scaletype == "quantile"){
            	v.push(parseFloat(d3.min(scale.domain())));
            	v = v.concat(scale.quantiles());
            	v.push(parseFloat(d3.max(scale.domain())));
            } else {
            	v.push(parseFloat(scale.domain()[0]));
            	for(var i = 0; i < r.length; i++) {
            		var k = (scale.domain()[1] - scale.domain()[0]) * (i+1) + scale.domain()[0];
            		v.push(k);
            	}
            	
            };
            
            
            // Draw the range (color blocks)
            var legend = svgMap.append("g")
            	.attr("id", "legend")
            	.selectAll(".legend")
                .data(r)
                .enter().append("rect")
                .attr("x", width - lsize - 50)
                .attr("y", function(d,i){
                    return height - 100 - i * (lsize + 1);
                })
                .attr("width",lsize / 2)
                .attr("height",lsize)
                .attr("fill", function(d){
                    return d;
                });

            // Draw the domain text (boundaries)
            leglabels = svgMap.select("#legend")
            				.selectAll(".leglabel")
            				.data(v)
            				.enter().append("text")
                			.attr("x", width - lsize - 30)
                			.attr("y", function(d,i){
                    			return height - 77 - i * (lsize + 1);
                			})
                			.text(function(d){return d.toFixed(2);})
                			.attr("font-family", "sans-serif")
                			.attr("font-size", "10px");
        }

        var updateLegend = function() {
            var r = scale.range();
            var v = [];
            if(scaletype == "quantile"){
            	v.push(parseFloat(d3.min(scale.domain())));
            	v = v.concat(scale.quantiles());
            	v.push(parseFloat(d3.max(scale.domain())));
            } else {
            	v.push(parseFloat(scale.domain()[0]));
            	for(var i = 0; i < r.length; i++) {
            		var k = ((scale.domain()[1] - scale.domain()[0]) / r.length) * (i+1) + scale.domain()[0];
            		v.push(k);
            	}
            	
            };

            //Update data: find a d3esque way of doing it
            for(var i = 0; i < leglabels[0].length; i++){
            	leglabels[0][i]["__data__"] = v[i];
            }

            leglabels.transition()
            		.duration(500)
            		.text(function(d){return d.toFixed(2);});
        };


        var updateVariableTxt = function(variable, variables) {
            // variable     the name of the variable
            // variables    a javascript object describing the variables, containing the reference to the description file
            if(variables[variable].txt != "") {
                $('#variabletxt').load("res/variabletxt/" + variables[variable].txt + ".html", function() {
                    MathJax.Hub.Queue(["Typeset", MathJax.Hub, "variabletxt"]);
                });
            } else {
                $('#variabletxt').empty();
            }
        };


        var updateInfoMetro = function(coId, mapper, div) {
                // Populate the infobox for the county and metro area
                // coId     county id (= FIPS code)
                // mapper   d3.mapper object
                // div      div of the metro infobox

                // Remove everything in the div
                d3.select(div)
                    .selectAll("*").remove();

                // County name
                d3.select(div)
                    .append("p")
                    .append("strong")
                    .text(mapper.get('countyname').get(coId) + ", " + mapper.get('statename').get(coId));

                // County population
                d3.select(div)
                    .append("p")
                    .text("County population: " + numeral(mapper.get({'variable':'countypop', 'date':date}).get(coId)).format('0,0'));

                var cbsa = mapper.get({'variable':'CBSAname', 'date':date}).get(coId);

                if(typeof cbsa == "string") {
                    d3.select(div)
                        .append("p")
                        .text("CBSA: " + cbsa);

                    d3.select(div)
                        .append("p")
                        .text("CBSA Population: " + numeral(parseInt(mapper.get({'variable':'CBSApop', 'date':date}).get(coId))).format('0,0'));
                };
            
        }

        // Create the mapper to map data with json
        var mapper = d3.atlas.mapper();

        // Create the menu to create the menu from the variable descriptor json and the data file
        var menu = d3.atlas.menu();

        queue()
            .defer(d3.json, "topo/us-euclidean.json")
            .defer(d3.csv, "data/A_MetroByCounty.csv")
            .defer(d3.json, "data/A_MetroByCounty_variables.json")
            .await(ready);

        function ready(error, us, data, variables) {

            // Map the data with json elements
            mapper.data(data)
                    .variables(variables)
                    .map();

            // Create menu elements based on variable descriptors
            menu.data(data)
            		.json(variables)
            		.spanId('menu')
            		.menu();

           	listeners();

            updateScale();
            makeLegend();

            thedata = data;
            topo = us;

            counties = svgMap.append("g")
                    .attr("class", "counties");

            counties.selectAll("path")
                .data(topojson.feature(us, us.objects.counties).features)
            .enter().append("path")
                .style("fill", function(d) {
                    var v = mapper.get({'variable':value, 'date':date}).get(d.id);
                    if(!isNaN(v)) {return scale(v);}
                    else {return noDataColor;}                       
                })
                .attr("d", path)
                .attr("id", function(d) {return d.id;})

                // Metro area highlighted on mouseover
                .on("mouseover", function() {
                	console.log("Mouse over");
                	var cbsa = mapper.get({'variable':'CBSAcode', 'date':date}).get(d3.select(this).attr("id"))
                	if(!isNaN(cbsa)){
                		var co = [];
                		mapper.get({'variable':'CBSAcode', 'date':date}).forEach(function(k, v) {
                			if(v == cbsa){co[co.length] = parseInt(k)};
                		});
                		console.log(co);
                        updateCounties(co);
                        updateInfoMetro(d3.select(this).attr("id"), mapper, divInfoMetro);
                	} else {
                        updateInfoMetro(d3.select(this).attr("id"), mapper, divInfoMetro);
                    };

                })

                .append("title")
                .text(function(d){
                    var title = mapper.get({'variable':'CBSAname', 'date':date}).get(d.id);
                    var county = mapper.get('countyname').get(d.id);
                    if(title != null) {
                    	return (county + ", " + title);
                    } else {
                    	return (county);
                    }
                })
                ;

            // Draw states borders
            var states = svgMap.append("path")
                            .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
                            .attr("class", "states")
                            .attr("id", "states")
                            .attr("d", path)
                            .style("stroke", "#fff")
                            .style("stroke-width", "0");

            

            ////////////////////
            // UPDATE METHODS //

            updateCounties = function(selected) {
            updateScale();
            updateLegend();
            //console.log("Redrawing counties")
            counties.selectAll("path")
                .data(topojson.feature(us, us.objects.counties).features)
                .transition()
                .duration(500)
                .style("fill", function(d) {
                    var v = mapper.get({'variable':value, 'date':date}).get(d.id);
                    //console.log(d.id);
                    if(selected != null) {
                        if(selected.indexOf(d.id) !== -1) {
                        // Color for when a county is selected
                        return selectColor;
                        } else {
                            if(!isNaN(v)) {return scale(v);}
                            else {return noDataColor;}
                        }
                    } else {
                        if(!isNaN(v)) {return scale(v);}
                        else {return noDataColor;}
                    };
                });
            }

            updateStates = function() {
                var w = 0;
                if(showstates == "yes") {w = 2;}
                svgMap.select("#states")
                    .transition()
                    .duration(500)
                    .style("stroke-width", w);
            }
            
        }

        var listeners = function() {
	       	d3.select("#valueselect")
	            .on("change", function() {
	                value = d3.select("#valueselect").node().value;
	                updateCounties();
                    updateVariableTxt(value, mapper.variables());
	            })


	        d3.select("#scaletype")
	            .on("change", function() {
	                scaletype = d3.select("#scaletype").node().value;
	                updateCounties();
	            })

	        d3.select("#dateselect")
	            .on("change", function() {
	                date = d3.select("#dateselect").node().value;
	                updateCounties();
	            })

	        d3.select("#showstates")
	            .on("change", function() {
	                showstates = d3.select("#showstates").node().value;
	                updateStates();
	            })
        };



        d3.select(self.frameElement).style("height", height + "px");

        </script>

        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-51162032-1', 'metroatlas.github.io');
            ga('send', 'pageview');
        </script>

    </body>
</html>